---
title: "Connection Map"
author: "Sahinya Akila, Prachi Jaiswal"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

```{r libraries}
library(tidyverse)
library(ggplot2)
library(sf)
library(broom)
library(readxl)
library(rgdal)
library(themis)
library(leaflet)
library(openxlsx)
```

```{r read_data}
# full_data <- read_csv(file.choose())

# SA3 Shape File
shapefile_df <- readOGR(dsn = paste0(getwd(), "/Data/SA3_2011/")) %>% 
  fortify(region = "SA3_NAME11") %>% 
  rename(alat = lat,
         along = long,
         aname = id)


# World Data Shape File
world_df <- readOGR( 
  dsn= paste0(getwd(),"/DATA/World_Shapefile/") , 
  layer="TM_WORLD_BORDERS_SIMPL-0.3",
  verbose=FALSE) %>% fortify(region = "NAME") %>% 
  rename(wlat = lat,
         wlong = long,
         wname = id)
```


```{r, cleaning}

imported <- file.choose()
virus_list <-  c("Dengue", 
                   "West_Nile_Kunjin", 
                   "Zika", 
                   "Chikungunya",
                   "Japanese_Encephalitis_Virus")
  
connection_data <- data.frame()
  
for(i in 1:5)
  {
    connection_data <- rbind(connection_data, read_excel(imported, sheet = i) %>%
                        add_column(Virus = virus_list[i]))
  }


 connection_data <- connection_data %>% 
   filter(!`Country of Origin` %in% c("No data available", "Overseas - Country unknown", 
                                      "At Sea", "Unknown", "No data supplied", "Australia") &
            !`Residential location (SA3)` %in% c("No data available", "Overseas - Country unknown", 
                                      "At Sea", "No data supplied", "Unknown")) %>% 
   mutate(`Country of Origin` = 
      ifelse(`Country of Origin` =="China (excludes SARs and Taiwan)", "China",
      ifelse(`Country of Origin` == "Venezuela, Bolivarian Republic of", "Venezuela",
      ifelse(`Country of Origin` == "Samoa, American", "Samoa",
      ifelse(`Country of Origin` == "Bolivia, Plurinational State of", "Bolivia",
      ifelse(`Country of Origin` == "Congo, Democratic Republic of", "Congo",
      ifelse(`Country of Origin` == "Macau (SAR of China)", "Macau",
      ifelse(`Country of Origin` == "United Kingdom, Channel Islands and Isle of Man", "United Kingdom",
      ifelse(`Country of Origin` == "Hong Kong (SAR of China)", "Hong Kong",
      ifelse(`Country of Origin` == "Congo, Republic of", "Congo", 
      ifelse(`Country of Origin` == "Myanmar, The Republic of the Union of", "Myanmar", `Country of Origin`)))))))))))
 
 connection_data <- connection_data[!grepl("nfd|nec", connection_data$`Country of Origin`),] 


```

```{r map}

# # Binding shape files
# joint_data <- rbind(world_df, shapefile_df)
# 
# ggplot() +
# geom_path(data = joint_data,
#           aes(x = long, y = lat, group = group),
#           color = 'Dark Green', size = .2)


# final_map_data <- final_map_data %>%
#   inner_join(. , shapefile_df, by=c("Residential location (SA3)"="aname"))


final_map_data <- connection_data %>% 
  inner_join(. , world_df, by=c("Country of Origin"="wname"))%>% 
  group_by(Virus, `Country of Origin`) %>% 
  summarise(wlat = mean(wlat),
            wlong = mean(wlong),
            count = sum(Count)) %>% 
  rename(wname = "Country of Origin") 
  
content <- paste(sep = "<br/>",
  "Virus Imported from: ", "<b>", final_map_data$wname, "</b>",
  "Type of Virus: ", "<b>", final_map_data$`Virus`, "</b>",
  "Total Imported Cases: ", "<b>", final_map_data$`count`, "</b>")


leaflet() %>%
  addTiles() %>%  
  addCircleMarkers(lng=final_map_data$wlong, lat=final_map_data$wlat, 
                   popup=content, radius = 4, opacity = final_map_data$count) %>%
  addMarkers(lng = 137, lat = -23.2,
             label = "Australia",
             labelOptions = labelOptions(noHide = T))


```



